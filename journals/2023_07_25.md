- # 暗号技術入門
- ## 第8章 メッセージ認証コード
- ### メッセージ認証コード(Message Authentication Code)
	- MACと呼ばれる
	- 任意長のメッセージと、送信者と受信者が共有する鍵を入力として、固定ビット長の出力を計算する関数
		- 出力はMAC値と呼ばれる
	- なりすましを検出することが出来る(認証)
		- 受信したMAC値と、受信側で計算したMAC値が等しければ、認証成功とする
		- 正真性も同時に検証することが出来る
	- 鍵配送問題が生じるため、鍵の事前共有、鍵配布センター、Diffie-Hellman鍵交換、公開鍵暗号のいずれかで解決する必要がある
	- 実現方法
		- 一方向ハッシュ関数を使って実現
			- HMACなど
		- AESのようなブロック暗号を使って実現
			- ブロック暗号の鍵をメッセージ認証コードの共通鍵とする
			- 初期化ベクトルを固定しておいて、CBCモードでメッセージ全部を暗号化する
			- 最終ブロックをMAC値として用いる
				- メッセージ全文の影響を受けるので
			- AESを用いたメッセージ認証コードとしてAES-CMACなど
- ### 認証付き暗号
	- 対称暗号とメッセージ認証コードを組み合わせることで、機密性、正真性、認証を同時に満たそうという仕組み
	- Encrypt-then-MAC : 平文を対称暗号で暗号化し、暗号文のMAC値を計算する
	- Encrypt-and-MAC : 平文を対称暗号で暗号化し、それとは別に平文のMAC値を計算する
	- MAC-then-Encrypt : 平文と平文のMAC値の両方をまとめて対称暗号で暗号化する方法
- ### HMACの手順
	- 鍵の前処理
		- 鍵が一方向ハッシュ関数のブロック長よりも短いなら、一方向ハッシュ関数のブロック長に一致するように、鍵の後に0をパディング
		- 鍵が一方向ハッシュ関数のブロック長よりも長いなら、一方向ハッシュ関数で鍵のハッシュ値を求めて、そのハッシュ値をHMACの鍵とする
	- 鍵とipadのXOR、鍵とopadのXORを計算する
		- ipad(inner pad)とは00110110をブロック長と同じ長さだけ繰り返したもの
		- opad(outer pad)とは01011100をブロック長と同じ長さだけ繰り返したもの
		- 鍵とipadのXORをipadkey, 鍵とopadのXORをopadkeyとする
	- ipadkeyとメッセージを連結したものを一方向ハッシュ関数の入力とし、ハッシュ値を計算
	- opadkeyと直前のハッシュ値を連結したものを一方向ハッシュ関数の入力とし、ハッシュ値を計算
		- このハッシュ値が目的のMAC値
	- 簡単に表すなら、hash((key ^ opad) || hash((key ^ ipad) || message))
		- keyは前処理された鍵
		- || は連結を意味する
	- 一方向ハッシュ関数の具体的なアルゴリズムに依存しない(交換可能)
- ### メッセージ認証コードに対する攻撃
	- 再生攻撃
		- 過去に送信されたメッセージとMAC値をもう一度送信する
		- 対策
			- シーケンス番号
				- 送信メッセージに毎回1ずつ増加する番号を振ることにし、MAC値の計算で、シーケンス番号も含めるようにする
				- 攻撃者はシーケンス番号が増えた時のMAC値を計算することが出来ない
				- 通信相手毎に最後のシーケンス番号を記録しておく必要がある
			- タイムスタンプ
				- 送信メッセージに現在時刻を埋め込むことにし、古いメッセージが送られてきた場合は、MAC値が正しくてもエラーとする
				- 送信者と受信者の間で時計を一致させておく必要がある
				- 許容する時刻の差に多少余裕を持たせる必要があるため、再生攻撃の余地は残っている
			- ノンス
				- 受信前に、受信者から送信者に使い捨てのランダムな値(ノンス)を渡す
				- 送信メッセージの中にノンスを含めてMAC値を計算する
				- 通信量が少し多くなる
- ### メッセージ認証コードで解決できない問題
	- 第三者に対する証明
		- AliceからBobにメッセージ認証コードを使って、メッセージを送信し、BobがAliceから受信したMAC値とBobが計算したMAC値と一致したとする
		- Bobはメッセージを送ったのがAliceだと分かるが、第三者のVictorに対して、メッセージを送ったのがAliceであると証明することは出来ない
			- VictorにとってはMAC値を計算したのがAliceなのかBobなのか分からないため
	- 否認防止
		- Aliceは「Bobにそんなメッセージを送っていない」とVictorに主張することが出来る
			- Aliceは「Bobが管理しているメッセージ認証コードの鍵が何者かに盗まれて、自分(Alice)になりすました存在からのメッセージでは」とか「Bobが勝手に作ったメッセージでは」と主張することが出来る
			- Victorは判断することは出来ない