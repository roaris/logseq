# 徳丸本
- ## 5章 代表的なセキュリティ機能(続き)
- ### 5.3 認可(続き)
- #### 5.3.3 認可制御の要件定義
	- 認可制御の要件を定義するためには、「権限マトリックス」というものを作成する
	- 権限マトリックスとは、横にロール名(システム管理者や一般ユーザなど)、縦に操作(ユーザの追加や他のユーザの情報の閲覧など)を並べて、操作が実行出来るなら○、実行出来ないなら×を書いたものである
		- [参考](https://blogs.oracle.com/sec/post/howto_015_access_matrix)(↑の説明と少し違うが)
	- 権限マトリックスがあることで開発やテストを正確に実施出来る
- #### 5.3.4 認可制御の正しい実装
	- 認可制御の不備の原因の多くは、画面の制御のみで認可制御を実装したつもりになっていること
	- 正しい認可制御とは、情報の操作の前に、ユーザにリソースを該当の操作をする権限があるかをチェックすること
	- ユーザ情報や権限情報はCookieやhiddenパラメータなどの外部から書き換え可能な場所に保持してはいけない
- ### 5.4 ログ出力
- #### 5.4.1 ログ出力の目的
	- 以下の目的でアプリケーションのログはセキュリティ上重要
		- 攻撃や事故を予測し、早期に対策する
			- ((6508872a-080c-4f25-87d3-39495c98c803)) など
		- 攻撃や事故の事後調査のため
			- ログが残ってなかったり、必要な情報がログにないと、調査が十分に出来ない
		- アプリケーションの運用監査のため
- #### 5.4.2 ログの種類
	- Webアプリケーションに関係するログは、Webサーバ(Nginx, Apache)のログ、アプリケーションログ、データベースのログに分類される
	- Webサーバ(Nginx, Apache)のログ
		- どちらも設定ファイルでアクセスログ、エラーログを書き出すファイルパスを指定する
		- Nginxの場合
			- 設定ファイルは/etc/nginx/nginx.conf
			- 一般的にはアクセスログは/var/log/nginx/access.log、エラーログは/var/log/nginx/error.logに書き出す(はず)
		- Apacheの場合([参考](https://go-journey.club/archives/14030))
			- 設定ファイルは/etc/httpd/conf/httpd.confなど
			- アクセスログは/etc/httpd/logs/access_log、エラーログは/etc/httpd/logs/error_logに書き出すなど
		- URLに秘密情報を埋め込むべきでないのは、埋め込んでしまうとWebサーバのアクセスログにそのまま記録されてしまい、アクセスログが漏洩した時の被害が大きくなってしまうため
			- POSTデータのログも残せるらしいが([参考1](https://mistymagich.wordpress.com/2014/02/26/nginx%E3%81%A7post%E3%81%97%E3%81%9F%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E3%83%AD%E3%82%B0%E3%81%AB%E6%AE%8B%E3%81%99/)、[参考2](https://qiita.com/shyamahira/items/417234d169e331138c2c))、本番環境でするべきではない
	- アプリケーションログ
		- エラーログ
			- サーバ側で発生したエラーはエラーログに出力する
				- そのままレスポンスに含めてはいけない(レスポンスを画面に表示しても利用者が困惑するし、エラー内容が攻撃者のヒントになる可能性もある)
			- エラーログは攻撃の検出に役立つことがある
				- SQLインジェクションやディレクトリトラバーサルでは、通常時には発生しないSQLのエラーやファイルオープンのエラーが発生するので、これらのエラーが続けて発生していたら攻撃を疑う必要がある
		- アクセスログ
			- 情報閲覧や機能の利用記録をアクセスログとして残す
			- Webアプリケーションが出始めた頃は、アプリケーションが残すのはエラーログだけで、正常系のログはWebサーバのアクセスログのみというケースが多かったが、個人情報の漏洩や事故への対応から、アクセスログの重要性が認識され始めた
		- デバッグログ
			- デバッグログを生成すると、ログのデータ量が膨大になり、パフォーマンスに影響が出る場合がある
			- デバックログから個人情報が漏洩した事例もあり、本番環境ではデバッグログを生成するべきではない
	- データベースのログ
		- MySQLでは一般クエリログ、スロークエリログ、バイナリログ、エラーログがある([参考](https://proengineer.internous.co.jp/content/columnfeature/7002))
- #### 5.4.3 ログ出力の要件
	- ログに記録すべきイベント
		- 認証・アカウント管理や重要な操作に関するイベントを記録する
		- ログイン・ログアウト(失敗も含む)、アカウントロック、ユーザ登録・削除、パスワード変更、重要情報の参照、重要な操作(物品の購入、送金、メール送信など)
	- ログの出力項目
		- 4W1H(いつ、誰が、どこで、何を、どのように)に従う
		- アクセス日時、リモートIPアドレス、ユーザID、アクセス対象、操作内容、操作対象、操作結果(成功 or 失敗、処理件数など)
		- 監査などでは複数のログを突き合わせて処理するので、ログの出力フォーマットを統一しておくと便利
	- ログの保護
		- ログに対して不正アクセスが出来ないように保護する必要がある
		- 加えて、個人情報などの機密情報は含めないようにするか、それが出来ない場合はマスク処理を施す
	- ログの出力先
		- ログ専用のサーバを用意することが望ましいと書かれているが、そこまでする必要はないのでは？と思う
		- アプリケーションと同じサーバにおいても適切にアクセス管理は出来るはずだし([参考](https://tex2e.github.io/blog/linux/nginx-access-deny))、別サーバにログを書き出すことにすると、アプリケーションのパフォーマンスに影響がありそう
	- ログの保管期間
		- 事後調査という目的を考慮すると、ログは無期限で保存するべきだが、誤って個人情報がログに含まれていた場合、保存期間が延びることで、漏洩の危険が増加してしまう
		- 定期的にログファイルを暗号化して長期保管に適した別のメディアに記録する
	- サーバの時刻合わせ
		- Webサーバ、データベース、メールなど様々なログを組み合わせて調査出来るようにするために、各サーバの時刻を同期させる必要がある
		- NTP(Network Time Protocol)を用いる([参考](https://eng-entrance.com/what-is-ntp))
- #### 5.4.4 ログ出力の実装
	- Log4jなどのログ出力用のライブラリを使うと以下のようなメリットがある
		- ログの出力先(ファイルやデータベースなど)が抽象化されていて設定だけで切り替えが出来る
		- ログの目的によって複数出力先を切り替えることが可能(どういうこと？)
		- ログのフォーマットを設定ファイルで指定可能
		- ログレベルを指定でき、開発環境と本番環境で同じソースコードを使える
			- [参考](https://www.techscore.com/tech/Java/ApacheJakarta/Log4J/1/)
			- 開発時にはログレベルをdebugにして、詳しいログ情報を取得しておき、本番環境ではinfoを指定して、デバック情報は出力しないようにするなど
			- まあログ出力用のライブラリを使わなくても簡単に出来ることな気がするけど