# 徳丸本
- ## 4章 Webアプリケーションの機能別に見るセキュリティバグ
- ### 4. 1 Webアプリケーションの機能と脆弱性の対応
	- 脆弱性には処理に起因するものと出力に起因するものがある
		- 出力には、HTTPレスポンスだけでなく、データベースアクセスやファイルアクセス、メール送受信なども含む(外部とのやり取りという意味で出力)
		- 出力に起因する脆弱性にはインジェクションという単語がつくものが多い
	- インジェクション系脆弱性
		- インジェクション系脆弱性が発生する原理は共通していて、データの終端を表す文字を混入させて、文字列の構造を変化させる
		- データの終端を表す文字
			- XSS : `<`や`"`
				- `<`からタグが開始されるので、これをデータの終端としているらしい(？)
			- HTTPヘッダインジェクション : 改行
			- SQLインジェクション : `'`
			- OSコマンドインジェクション : `;`や`|`
			- メールヘッダインジェクション : 改行
- ### 4. 2 入力処理とセキュリティ
	- 文字エンコーディングの話は飛ばす(6章で文字コードと文字エンコーディングについて説明されるため)
	- 入力値検証はシステムの信頼性とユーザビリティを向上させる
		- 入力値検証がないと以下のことが起きる可能性がある
			- 数値のみを受け付ける項目に英語や記号を入力して、データベースのエラーになる
				- 更新途中でエラーとなり、データベースの不整合が発生する可能性がある(ロールバックされない場合)
			- ユーザが多数の項目を入力して実行ボタンを押した後に、システム側でエラーとなり入力を最初からやり直すことになる
	- 入力値検証の目的はセキュリティのためではないが、以下のようにセキュリティに役立つこともある
		- SQLインジェクションの脆弱性があるが、英数字のみを許可していたため実害には至らない
		- バイナリセーフでない関数を使っているが、制御文字のチェックをしていたため実害には至らない
	- バイナリセーフとヌルバイト攻撃
		- バイナリセーフとは、入力値がどんなバイト列であっても正しく扱えること
		- C言語やUnix, WindowsのAPIでは、ヌルバイトを文字列の終端と見なす取り決めがある
		- そのため、C言語で開発されたPHPには、ヌルバイトを文字列の終端とし、それ以降を切り詰めてしまう関数が存在する(バイナリセーフでない)
			- 例えば、eregという正規表現関数がそうである
				- 第一引数に正規表現、第二引数に文字列を受け取り、文字列が正規表現にマッチしているかを返す
				- XSSを対策するために、入力値のバリデーションをしていても、ヌルバイトを入力値に加えると、バリデーションを回避されてしまう(ヌルバイト攻撃)
				- ```php 
				  <?php
				  $p = "abc123%00<script>alert('XSS')</script>";
				  echo ereg("^[0-9a-z]+$", $p); # 1
				  ?>
				  ```
		- ヌルバイト攻撃は単独で被害を与えるものではなく、他の脆弱性の対策を回避するために用いられる
		- ファイル名のようにヌルバイトを許容しないパラメータがあるため、バイナリセーフな関数のみを用いてアプリケーションを開発することは難しい
		- 入力値にヌルバイトが存在しないことをチェックすれば良い
	- セキュリティ面では、入力値検証はあくまでも保険的対策として捉えるべき
		- 入力値検証はアプリケーションの仕様が基準であるため、「全ての文字を許容する」という仕様の場合、入力時点では何も防げない
	- 入力値検証の基準
		- 制御文字のチェック
			- 制御文字とは、改行やタブなど通常表示されることのない、ASCIIコード0x20未満及び0x7Fの文字のこと
			- Webアプリケーションの入力パラメータはテキストの場合が多いので、全ての文字を許容する場合でも、制御文字に関しては制限を設けるべき
				- PHPの場合、`[[:^cntrl:]]`というPOSIX文字クラスによって制御文字以外という指定をすることが出来る
				- textareaタグに入力された値は、改行と場合によってはタブを許容する必要がある
		- 文字数のチェック
			- 最大文字数をチェックしておくと、保険的対策になる場合がある
				- 10文字以内という制限があると、SQLインジェクションの脆弱性はあるが、攻撃には至らないなど
		- 数値の最小値、最大値のチェック
			- 入力された数値分の長さの配列を確保するようなアプリケーションの場合、大きな数字を指定することによるDoS攻撃などが考えられる