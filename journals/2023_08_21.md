# 徳丸本
- ## 4章 Webアプリケーションの機能別に見るセキュリティバグ(続き)
- ### 4.8 Cookie出力にまつわる脆弱性
- #### 4.8.1 Cookieの不適切な利用
	- 書き換えられたら困る情報をCookieに保存してはいけない(ユーザIDや権限情報など)
- #### 4.8.2 CookieのSecure属性不備
	- HTTPSのみのサイトであってもSecure属性をつけないとCookieが盗聴される可能性がある
	- 攻撃例
		- 正規サイトをhttps://example.jpとして、このサイトからSecure属性がついていないCookieが利用者に付与されている
		- 利用者が罠サイトを閲覧する
		- 罠サイトからhttp://example.jp:443にリクエストが送信される
		- 443番ポート(HTTPS)にHTTPでリクエストを送信したので、リダイレクトされずにエラーになったとしても、リクエスト自体は送信されていて、このリクエストにCookieが含まれる
		- 暗号化されていない状態でCookieが送信されているので盗聴可能
	- 本では罠サイト中のimgタグのsrc属性でリクエストを送信しているが、SameSite属性がLaxであるため、リクエスト中にCookieは含まれない
	- 対策
		- HTTPとHTTPSが混在していて、Secure属性をつけられないのであれば、全てHTTPSにしてSecure属性をつける
		- 全てHTTPSにすることが出来ない場合は、トークンを利用することで、Cookieを盗聴された場合でも、HTTPSのページに関してはセッションハイジャックを防ぐことが出来る( ((64e19f0d-9e36-4788-8940-87cf0bc35d12)) と同じ方法)
			- トークンのCookieにはSecure属性を付与する
			- PHPの場合、[タイミング攻撃](https://corgi-lab.com/programming/timing-attack/)に耐性があるhash_equals関数を使ってトークンの一致確認を行うと良い
- ### 4.9 メール送信の問題
- #### 4.9.1 メール送信の問題の概要
	- メールヘッダ・インジェクション
		- 宛先や件名などのヘッダフィールドに改行を挿入して、新たなフィールドを追加したり、本文を改竄する
	- hiddenパラメータによる宛先保持
		- 送信先アドレスを書き換えて迷惑メールの送信に悪用される
		- 送信先メールアドレスはhiddenパラメータではなく、サーバ上に保持するべき
	- メールサーバによる第三者中継
		- 迷惑メールを直接送信すると受信拒否されてしまうので、第三者中継を許可するメールサーバを探して、このサーバに迷惑メールを中継してもらう
		- 最近のメールサーバソフトはデフォルトで第三者中継を許さない設定になっている
- #### 4.9.2 メールヘッダ・インジェクション
	- メールのメッセージ形式はHTTPと同様、ヘッダ(To, Subject, Fromなど)とボディがあって、ヘッダとボディは空行で区切られている
	- HTTPヘッダ・インジェクションと同じ理屈で発生する
	- Fromヘッダの値を外部の入力から指定できる場合
		- `alice%40example.jp%0D%0ABcc%3A+bob%40example.jp`を与えると、ヘッダは以下のようになり、bob@example.jpにBccで送信される
			- ```
			  From: alice@example.jp
			  Bcc: bob@example.jp
			  ```
			- Bccで送信されているので、管理者(正規の送信先)はbob@example.jpにメールが送られていることに気付かない
		- Fromヘッダに`alice%40example.com%0D%0A%0D%0ASuper+discount+PCs+80%25+OFF%21+http%3A%2F%2Ftrap.example.com%2F`、メッセージ本文に`abc`を与えると、ボディは以下のようになる
			- ```
			  Super discount PCs 80% OFF! http://trap.example.com/
			  Mime-Version: 1.0
			  Content-Type: text/plain; charset=ISO-2022-JP
			  Content-Transfer-Encoding: 7bit
			  
			  $B0J2<$NLd$$9g$o$;$,$"$j$^$7$?$N$GBP1~$*4j$$$7$^$9(B
			  
			  abc
			  ```
			- 本来ヘッダだった部分(Mime-Version, Content-Type, Content-Transfer-Encoding)が本文に来ていて、謎の文字列も本文に来ている
				- 改行を多く入れてごまかしたり、MIMEを使って隠すことが出来るらしい
				- 添付ファイルをつけることも出来るらしい
			- 本文が外部から指定出来るのであれば、わざわざFromヘッダを使って本文を改竄する必要はない気がする
	- 対策
		- メール送信に専用のAPIやライブラリを使用する
			- これでどう解決するのか分からないが...
		- 外部からのパラメータをメールヘッダに含ませないようにする
		- 外部からのパラメータに改行が含まれていないかチェックする
	- 保険的対策
		- メールアドレスのチェック
		- 件名のチェック
			- 書式や文字種の制限がないため、制御文字以外からなることをチェックすれば良い( ((64d7a57c-4383-43f1-9dc6-ae8455294530)) )
- ### 4.10 ファイルアクセスにまつわる問題
- #### 4.10.1 ディレクトリ・トラバーサル
	- テンプレートファイルを外部のパラメータで指定出来るような場合、ディレクトリトラバースが可能である場合がある
	- 外部から受け取ったパラメータの末尾に`.html`を追加して、このHTMLを返すようになっているとする(パラメータが`abc`なら`abc.html`の内容が返される)
	- 末尾に`.html`が追加されるため、`/etc/passwd`などの閲覧は出来ないような気がするが、PHPのreadfile関数はバイナリセーフでないため、`../../../../../../etc/passwd%00`とすることで`/etc/passwd`の内容を見ることが出来る([同様の内容](https://security.stackexchange.com/questions/137343/exploiting-the-php-readfile-function-when-a-filename-is-appended-to-the-path))
		- ルートディレクトリの親はルートディレクトリなので`..`はたくさん書けば良い
		- 他にも`/etc/hosts`を見れたりする
		- `/etc/passwd`は各ユーザのホームディレクトリなどが書かれたファイル([参考](https://www.ikueikan.ac.jp/biblion/1997/sysadmin/node18.html))
			- 自分が見当たらないが...
		- `/etc/hosts`はDNSよりも前に名前解決に使われていたファイル([参考](https://linuc.org/study/knowledge/506/))
			- 小規模な検証に使われる
			- 大抵はDNSよりも/etc/hostsを優先して名前解決を行う
	- `/etc/passwd`は固定のファイル名だが、それ以外のファイル名を知りたい時は、ディレクトリトラバーサルでソースコードを取得して、ソースコード中で開いているファイル名を調べるという方法が使える
		- それでもソースコードのパスが分からないといけないが...
	- ファイルの改竄や削除も出来る場合があるらしいが、調べても出てこない
	- 対策
		- 外部からファイル名を指定出来ないようにする
			- ファイル名を固定にする、番号で間接的に指定するなど
		- ファイル名にディレクトリ名が含まれないようにする
			- PHPのbasename関数を使うとディレクトリ付きのファイル名から最後の名前の部分を取り出すことが出来る(`../../../../../../etc/passwd`なら`passwd`となる)
				- OS毎に違うディレクトリの記号を考慮して作られている
			- basename関数はPHP5.0.0でバイナリセーフになり、readfile関数はPHP5.3.4からヌルバイトがあるとエラーになるようになった
			- PHP5.0.0 ~ 5.3.3では、basename関数がバイナリセーフ、readfile関数がバイナリセーフでないという組み合わせによって危険になっていた([参考](https://twitter.com/ockeghem/status/1347357074041147392))
				- `readfile(basename($_GET['f']) . ".txt")`のような場合、`a.php%00`がパラメータに与えられると、basename関数がバイナリセーフなので、`readfile("a.php%00.txt")`となり、readfile関数がバイナリセーフでないので、`a.php`を読み込むことになる
				- basename関数がバイナリセーフでないなら、`a.php.txt`を読み込むことになる
		- ファイル名を英数字に限定する
- #### 4.10.2 意図しないファイル公開
	- 非公開のファイルを公開ディレクトリに配置していると見られてしまう可能性がある
	- 非公開のファイルのURLを知るための手段
		- ディレクトリ・リスティングが有効になっている
		- 類推可能、ありがちな名前
		- エラーメッセージから分かる
		- 検索エンジンに登録されている
	- 対策
		- ファイルの安全な格納場所を決めて、非公開ディレクトリとする
	- 保険的対策
		- ディレクトリ・リスティングを無効にする