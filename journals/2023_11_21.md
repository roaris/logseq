# はじめて学ぶバイナリ解析
- 環境構築
	- VirtualBox 7.0
	- Ubuntu_for_binary_analysis.ovaをダウンロードしてきて、VirtualBoxのファイル→仮想アプライアンスのインポートで、Ubuntu_for_binary_analysis.ovaを指定
- hexedit : バイナリエディタを起動
- gccでは-Sをつけるとコンパイルをアセンブリコードの段階で止めることが出来る
	- ```
	  $ gcc compile_2-1.c -S # compile_2_1.sが作成される
	  $ cat compile_2-1.s # テキストファイルなのでcatで見れる
	  ```
- strings : 指定したバイナリを1バイト毎にASCIIコードとして解釈してみて、印字可能な文字が連続している部分があれば抜き出して表示してくれるコマンド
	- ```
	  $ strings a.out | grep ^[^_.]
	  ```
	- _や.から始まる文字列が多いので取り除きたい
	- \[^\_.]は_と.を除く全ての文字を表し、^\[^\_.]と書くことで、_と.以外の文字から始まる文字列を抽出出来る
- echoでは-eをつけるとASCIIコードを文字に変換することが出来る
	- ```
	  $ echo -e "\x21"
	  !
	  ```
	- 通常入力出来ない印字不可能な文字(0x20未満及び0x7Fの文字のこと)(制御文字とも言う)も出力させることが出来る
- Pythonライブラリのpwntoolsはプロセスと入出力のやり取りをするツール
	- ```python
	  from pwn import *
	  p = process('./a.out')
	  p.sendline('\x01\x02\x03\x04\x05')
	  print(p.recvline())
	  ```
	- processで、プロセスを立ち上げる(上の例では、process('./a.out')となっているが、process('cat')とかでも良い)
	- sendlineで、バイナリを実行しているプロセスに標準入力として、sendlineの引数が渡される
	- recvlineで、バイナリを実行しているプロセスの標準出力を改行が現れるところまで出力する
- バイトオーダ
	- 123456789という数値は16進数で表現すると、0x499602d2となる
	- CPUのメモリには1バイト毎にアドレスが割り振られている
	- アドレスの昇順に0x49 0x96 0x02 0xd2と並べるのがビッグエンディアン
	- アドレスの昇順に0xd2 0x02 0x96 0x49と並べるのがリトルエンディアン
	- リトルエンディアンが使われることが多い
	- バイトオーダを考えるのは、1つのデータが複数バイトにまたがる時だけ
	- 文字列は文字型の配列で、配列はバイトオーダ関係なく、添字の小さい方がアドレスの小さい方に配置される
		- ```c
		  #include <stdio.h>
		  
		  int main(void){
		      char s[] = "flag";
		      printf("%p\n", &s[0]); // 0x7ffeb0797c03
		      printf("%p\n", &s[1]); // 0x7ffeb0797c04
		      printf("%p\n", &s[2]); // 0x7ffeb0797c05
		      printf("%p\n", &s[3]); // 0x7ffeb0797c06
		  }
		  ```
- # 徳丸本
- ## 8章 Webサイトの安全性を高めるために
- ### 8.2 成りすまし対策
	- 成りすましとは、偽のWebサイトが正規サイトに成りすますこと
	- 手法
		- ネットワーク的な成りすまし
		- Webサイトのデザインだけを似せたフィッシング
- #### 8.2.1 ネットワーク的な成りすましの手口
	- DNSに対する攻撃
		- ドメイン名ハイジャック
			- 前提知識
				- レジストリとレジストラ([参考](https://www.nic.ad.jp/ja/basics/terms/registry-registrar.html))
					- レジストリは、登録ドメイン名のデータベースを維持管理する機関(JPRSなど)
					- レジストラは、登録者からドメイン名の登録申請を受け付け、その登録データをレジストリのデータベースに登録する機関([JPRSと契約しているレジストラの一覧](https://jprs.jp/registration/list/pickup_list.php))
				- 権威DNSサーバ([参考](https://jprs.jp/glossary/index.php?ID=0145))
					- 他のサーバに問い合わせることなく応答を返すことが出来るサーバのこと
				- NSレコード([参考](https://jprs.jp/glossary/index.php?ID=0146))
					- 権威DNSサーバを指定するためのレコード
				- jpドメイン名の権威DNSサーバはa.dns.jp ~ h.dns.jpがある([参考](https://jprs.jp/registration/list/pickup_list.php))
				- 例えば、a.dns.jp(JPRSが運用)に`example.jp IN NS ns.example.jp.`というNSレコードがあった場合、example.jpに関しては、ns.example.jpに委任しているという、権限委譲を意味する
					- ns.example.jpが持っているAレコードからIPアドレスが分かる
					- `example.jp IN NS ns.example.jp.`をa.dns.jpに登録するのは、ドメイン名を購入したレジストラが提供する管理画面から行える
			- ドメイン名ハイジャックとは、レジストラが提供する管理画面を乗っ取り、権威DNSサーバの情報を書き換えて、偽サイトに誘導するという攻撃
			- 例えば、`example.jp IN NS ns.example.jp.`を`example.jp IN NS evil.example.com.`に書き換えることで、evil.example.comが持っているAレコードのIPアドレスにアクセスさせることが出来る
		- DNSキャッシュポイズニング
			- DNSキャッシュサーバに対して問い合わせを行い、権威DNSサーバから応答が返ってくる前に、偽の応答パケットをキャッシュサーバに送信し、偽サーバのIPアドレスをキャッシュさせる([参考](https://www.nic.ad.jp/ja/newsletter/No40/0800.html))
	- ((651eef03-3bb4-461c-a1f6-4c9105e0a727))
- #### 8.2.2 フィッシング
	- 正規サイトにそっくりな入力画面を用意して、メールなどで利用者を誘導し、IDとパスワードや個人情報などを入力させて盗み取る手法
- #### 8.2.3 Webサイトの成りすまし対策
	- ネットワーク的な対策
		- DNS運用の強化
			- DNSSECなど(権威DNSサーバが応答に電子署名を行い、キャッシュサーバがその署名を検証することで、偽の応答を弾くことが出来る)
		- 同一セグメント内に脆弱なサーバを置かない
			- ARPスプーフィングの影響は同一セグメント内に限られるため、同一セグメント内に危険なサーバを置かないことが対策の1つ
	- TLSの導入
		- 偽サイトに誘導されたとしても、サーバに証明書が無かったり、不正な証明書を使用している場合は、ブラウザが警告を出す
	- 確認しやすいドメイン名の採用
- ### 8.3 盗聴・改竄対策
- #### 8.3.1 盗聴・改竄の経路
	- 無線LANの盗聴・改竄
	- ミラーポートの悪用
	- プロキシサーバの悪用
	- 偽のDHCPサーバ
		- DNSやデフォルトゲートウェイのIPアドレスを偽装可能
	- ARPスプーフィングとDNSキャッシュポイズニング
		- 成りすましだけでなく、盗聴や改竄も可能
- #### 8.3.2 中間者攻撃
	- 利用者と対象サイトの間に割り込んで、HTTPS通信を一旦復号し、盗聴・改竄を行った後、再度暗号化して流す
	- プロキシツールが行なっているのは中間者攻撃と一緒
	- 何もしていないと、プロキシツールの証明書が不正であるとブラウザに判断され、エラーとなるが、プロキシツールの証明書をPCにインストールすることで(Macならキーチェーンアクセスにインストール)、信頼させることが出来る
- #### 8.3.3 対策
	- 入力画面からHTTPSにする
	- CookieのSecure属性をつける
	- 画像やCSS、JavaScriptなどもHTTPSで指定する
	- frame, iframeを使わない
	- ブラウザのデフォルト設定でエラー表示されないようにする
		- ブラウザにエラーを表示されないようにアプリケーションを開発する(脆弱なSSL3.0を使わない、正規の証明書を導入するなど)
	- アドレスバーを隠さない
	- ステータスバーを隠さない(Windowsの話？)
	- コンテキストメニュー(右クリックメニュー)を無効化しない(これもWindowsの話？)
- ### 8.4 マルウェア対策
- #### 8.4.1 Webサイトのマルウェア対策とは
	- Webサーバがマルウェアに感染しないこと
		- マルウェアに感染すると、OSコマンドインジェクションと同じ被害を受ける
	- Webサイトを通じてマルウェアを公開しないこと
		- Webサイトを通じてマルウェアを公開してしまうと、Webサイトを閲覧した利用者のPCがマルウェアに感染する
- #### 8.4.2 マルウェアの感染経路
	- マルウェアの感染経路は、電子メールが89.7%、ネットワークが9.2%
	- Webサーバ上ではメールを閲覧するという操作は通常発生しないため、Webサーバのマルウェア感染は、サーバの脆弱性を悪用された結果であることが多い
- #### 8.4.3 Webサーバのマルウェア対策の概要
	- サーバの脆弱性対処をタイムリーに行う、出所不明なプログラムをサーバに持ち込まない、サーバに接続するクライアントPCにウイルス対策ソフトを導入してパターンファイルを最新に保つなど
- #### 8.4.4 Webサーバにマルウェアを持ち込まない対策
	- Webサーバにマルウェアが持ち込まれる経路として、Webアプリケーションのファイルアップロード機能の悪用、FTPなど管理ソフトに対する不正ログイン、マルウェアに感染した管理用PCからの感染など
	- マルウェア対策の要否を検討する
	- ポリシーを定めて利用者に告知する(対策をしない場合も含めて)
	- ウイルス対策ソフトによる対処
		- サーバにウイルス対策ソフトを導入し、アップロード領域を検査対象として設定する
		- ウイルス対策ゲートウェイ製品を通過させる
		- ウイルス対策ソフトのAPIを利用して検査処理を作り込む
- ## 9章 安全なWebアプリケーションのための開発マネジメント
	- これはSKIPで良いでしょう