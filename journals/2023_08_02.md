- # 暗号技術入門
- ## 第11章 鍵
- ### セッション鍵とマスター鍵
	- 通信毎に一度しか使われない鍵をセッション鍵と呼ぶ
		- セッション鍵が漏洩したとしても、解読されるのはその通信だけ
			- 過去に遡って機密性が破られない(=前方秘匿性を持つ)
		- セッション鍵を作る時に使う擬似乱数生成器の質が悪いと、次に生成されるセッション鍵が予測される可能性がある
	- セッション鍵に対し、繰り返し使われる鍵をマスター鍵と呼ぶ
- ### CEKとKEK
	- メッセージを暗号化する鍵をCEK(Contents Encrypting Key)と呼び、これに対し、鍵を暗号化する鍵をKEK(Key Encrypting Key)と呼ぶ
	- セッション鍵はCEKとして使われ、マスター鍵はKEKとして使われることが多い
	- 大量のCEKがある場合でも、1本のKEKで暗号化しておけば、守るべきなのは1個のKEKだけになる
		- 認証局の階層化と似ている(たくさんの認証局を信用する代わりに、1つのルートCAを信用するのと同様に、大量のCEKの機密性を守る代わりに、1個のKEKの機密性を守る)
- ### 鍵の更新
	- 共通鍵を使って暗号化をしている時、定期的に鍵を変えていく
		- 一方向ハッシュ関数を使って、鍵のハッシュ値を取り、その値を次の鍵とする
	- 通信のある時点で鍵が漏洩したとしても、過去に遡って通信を復号化することは出来ないという利点を持つ
		- 一方向ハッシュ関数の一方向性によるもの
		- 過去に遡った解読を防止することをバックワードセキュリティと呼ぶ
- ### 鍵の廃棄
	- 不要になった鍵はさっさと削除した方が良い
	- ファイルに鍵が書かれている場合、そのファイルを削除しただけでは鍵を削除したことにならない
		- 削除したファイルを復活させることが出来たりするのと、ファイルの内容がメモリ上に残っているかもしれないため
		- きちんと鍵を削除するためにはコンピュータ全体がセキュリティを意識した設計になっていないといけない
- ### Diffie-Hellman鍵交換
	- 鍵配送問題を解決する方法の1つ
	- 実際には鍵交換ではなく、共有する鍵を計算によって作り出している
	- 手順
		- AliceとBobの間で2つの素数PとGを共有する
			- PとGは盗聴者に知られても良い
			- PとGを作るのはAliceでもBobでも良い
			- Pは非常に大きな素数である必要がある
			- GはPの生成元というもので、G<P
		- Aliceは1≤A≤P-2となる乱数Aを用意、Bobは1≤B≤P-2となる乱数Bを用意する
			- AはAliceだけの秘密、BはBobだけの秘密にする
		- AliceはBobに対してG^A mod P、BobはAliceに対してG^B mod Pを送信する
			- この値は盗聴者に知られても良い
		- Aliceは受け取った値(G^B mod P)をA乗してmod Pを取り、Bobは受け取った値(G^A mod P)をB乗してmod Pを取る
			- これによってAliceとBobは共通鍵(G^(AB) mod P)を手に入れることが出来た
			- AやBをP-1にすると、フェルマーの小定理からG^A mod PやG^B mod Pが1になってしまい、共通鍵が1になってしまう(AとBがP-2以下なのはそのため)
	- 盗聴者はAかBさえ分かれば、共通鍵を計算することが出来るが、P, G, G^A mod P, G^B mod PからAとBを計算することは難しい(有限体の上の離散対数問題と呼ばれる)
	- 中間者攻撃が可能
		- AliceがG^A mod Pを送信した時に、Malloryがそのメッセージを奪い取り、AliceのふりをしてG^X mod PをBobに送信する
		- BobがG^B mod Pを送信した時に、Malloryがそのメッセージを奪い取り、BobのふりをしてG^Y mod PをAliceに送信する
		- MalloryがAliceとの通信ではG^A^Y mod Pを共通鍵として使い、Bobとの通信ではG^B^X mod Pを共通鍵として使う
		- そのためデジタル署名や証明書などの対策が必要になる
			- IPsecで使われているDiffi-Hellman鍵交換では、中間者攻撃への対策がされている
- ### PBE(Password Based Encryption)
	- 頭の中にあるパスワードを元にして作った鍵で暗号化を行う方法
	- モチベーション
		- メッセージをディスクにそのまま保存したくないからCEKを使って暗号化しよう
		- CEKをディスクにそのまま保存したくないからKEKを使って暗号化しよう
		- このままでは堂々巡りなので、KEKはパスワードを使って生成することにする
		- パスワードだけだと辞書攻撃を受ける危険があるので、パスワードとソルトを繋げたものを一方向ハッシュ関数に入力して、KEKを作る
		- ソルトと暗号化したCEKを保存することにしてKEKは保存しないようにしよう
	- 一方向ハッシュ関数を何度も通してKEKを作ることで安全性を高めることが出来る
		- ストレッチングという
		- KEKを作る上でさほど負担にはならないが(ハッシュ値の計算が高速であるとして)、攻撃者にとっては大きな負担になる