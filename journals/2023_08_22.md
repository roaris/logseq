# 徳丸本
- ## 4章 Webアプリケーションの機能別に見るセキュリティバグ(続き)
- ### 4.11 OSコマンド呼び出しの際に発生する脆弱性
- #### 4.11.1 OSコマンド・インジェクション
	- 多くのプログラミング言語ではシェル経由でOSコマンドを呼び出す機能を提供している
		- PHPの場合はsystem関数
		- `system("echo hello > a.txt")`は`/bin/sh -c echo hello > a.txt`を実行する
		- 今更だけど[シェルとターミナルの違い](https://zenn.dev/k_log24/articles/582af625164d41)
			- シェルはbashとかzsh、ターミナルはiTermとか[Warp](https://www.warp.dev/)とか
	- 送信先メールアドレスを外部から受け取り、sendmailコマンドを使ってメールを送信するプログラムが以下のようになっているとする
		- ```php
		  system("/usr/sbin/sendmail -i <template.txt $mail")
		  ```
		- template.txtはメールの文面が書かれたファイル
			- ```
			  From: ...
			  Subject: ...
			  Content-Type: text/plain; charset="UTF-8"
			  Content-Transfer-Encoding: 8bit
			  
			  メッセージ
			  ```
		- `<`を使うと標準入力をファイルに切り替えることが出来る
			- `python main.py <input.txt`とか
		- `-i`をつけると`.`だけの行をメールの終端として扱わない([参考](https://fumiyas.github.io/2014/12/13/sendmail.postfix-advent-calendar.html))
	- `$mail`を`alice@example.com; cat /etc/passwd`にすると、メール送信だけでなく、/etc/passwdの表示も実行されてしまう
		- 本のWebアプリでは、ブラウザに/etc/passwdの内容が出てくるようになっているが、ただcatしただけなのにブラウザに表示されるのはなぜか分からない(ソースコードを見ようにも、仮想マシン中のどこにあるのか分からず)
	- ファイルの表示だけでなく削除、変更や、外部からファイルをダウンロードしたりも可能
	- 本来はWebアプリケーションが稼働するユーザ権限でしか実行出来ないが、OSの脆弱性を突くプログラムを外部からダウンロードして、これを使って権限昇格する(root権限を得る)ことが出来る
	- シェルには1行で複数のコマンドを実行する方法が用意されている
		- `;`
			- コマンドを続けて実行する
		- `&`
			- `&`をつけるとバックグラウンドで実行がされる
			- `sleep 1 & echo hoge`は`sleep 1`がバックグラウンドで実行され、`echo hoge`がフォアグラウンドで実行される
			- `echo hoge`はすぐに実行される
			- `sleep 1; echo hoge`であれば、1秒経った後に`echo hoge`が実行される
		- `&&`
			- 最初のコマンドが成功したら次のコマンドを実行する
		- `||`
			- 最初のコマンドが失敗したら次のコマンドを実行する
	- シェルの利用時に特別な意味を持つ記号文字をシェルのメタ文字と呼ぶ
		- OSコマンドのパラメータとして指定する文字列にメタ文字が混入することで、OSコマンド・インジェクションが引き起こされる
		- bashでは`\`などでエスケープ出来る([参考](https://anmino.hatenadiary.org/entry/20090728/1248805534))
	- OSコマンドをsystem関数などで明示的に呼んでいなくても、シェル機能を呼び出せる関数を使用している場合はOSコマンド・インジェクションが可能になる場合がある
		- 本ではopen関数の例が書かれていたが、理解出来なかった
	- 対策
		- OSコマンド呼び出しを使わない実装方法を選択する
			- PHPの場合、メール送信であればsendmailコマンドの代わりにmb_send_mail関数を使うことが出来る
		- シェル呼び出し機能のある関数の利用を避ける
			- Perlによるシェルを経由しない関数の呼び出し方が書かれていたが、理解出来なかった
		- 外部から入力された文字列をコマンドラインのパラメータに渡さない
			- sendmailコマンドは`-t`をつけるとメールの宛先をToヘッダから読み取る
			- 上の例中のtemplate.txtにToヘッダを書いておけば、外部から受け取った宛先がsendmailコマンドのパラメータになることはない
		- OSコマンドに渡すパラメータを安全な関数によりエスケープする
			- シェルのエスケープルールは複雑なので、自作よりも安全なライブラリを用いる
			- PHPの場合はescapeshellarg関数が使える
				- ```php
				  system("/usr/sbin/sendmail -i <template.txt" . escapeshellarg($mail));
				  ```
		- OSコマンドに渡すパラメータを環境変数経由で渡す
			- 上の例中の`$mail`を環境変数として定義して、system関数で呼ぶOSコマンド中でその環境変数を参照する
			- メタ文字が含まれていても、メタ文字と認識されないため、OSコマンド・インジェクションを防ぐことが出来る
	- 保険的対策
		- 入力値検証
			- パラメータで使える文字をメールアドレスで使える文字だけに限定するとか
		- アプリケーションの稼働するユーザ権限を最小にする
			- ディレクトリ・トラバーサルにおいても有効
		- WebサーバのOSのパッチ適用
			- OSの脆弱性を突かれてroot権限が取られないようにする
		-